!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("videojs"),require("RecordRTC")):"function"==typeof define&&define.amd?define("VideojsRecord",["videojs","RecordRTC"],t):"object"==typeof exports?exports.VideojsRecord=t(require("videojs"),require("RecordRTC")):e.VideojsRecord=t(e.videojs,e.RecordRTC)}(window,function(e,t){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(t,i){t.exports=e},function(e,t,i){(function(t){var i;i="undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{},e.exports=i}).call(this,i(4))},function(e,i){e.exports=t},function(e,t,i){i(6),e.exports=i(5)},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){},function(e,t,i){"use strict";i.r(t);var r=i(0),s=i.n(r);const o=s.a.getComponent("Component");class a extends o{createEl(){return super.createEl("div",{className:"vjs-animation-display",innerHTML:"<img />"})}}o.registerComponent("AnimationDisplay",a);var n=a;const h=s.a.getComponent("Component");class d extends h{createEl(){return super.createEl("div",{className:"vjs-record-canvas",innerHTML:"<canvas></canvas>"})}}h.registerComponent("RecordCanvas",d);var c=d;const l=s.a.getComponent("Button"),p=s.a.getComponent("Component");class u extends l{handleClick(e){this.player_.record().getDevice()}show(){this.layoutExclude&&!0===this.layoutExclude||super.show()}}u.prototype.controlText_="Device",p.registerComponent("DeviceButton",u);var y=u;class m{}m.READY="ready",m.ERROR="error",m.LOADEDMETADATA="loadedmetadata",m.LOADSTART="loadstart",m.USERINACTIVE="userinactive",m.TIMEUPDATE="timeupdate",m.DURATIONCHANGE="durationchange",m.ENDED="ended",m.PAUSE="pause",m.PLAY="play",m.DEVICE_READY="deviceReady",m.DEVICE_ERROR="deviceError",m.START_RECORD="startRecord",m.STOP_RECORD="stopRecord",m.FINISH_RECORD="finishRecord",m.RECORD_COMPLETE="recordComplete",m.PROGRESS_RECORD="progressRecord",m.TIMESTAMP="timestamp",m.ENUMERATE_READY="enumerateReady",m.ENUMERATE_ERROR="enumerateError",m.AUDIO_BUFFER_UPDATE="audioBufferUpdate",m.AUDIO_OUTPUT_READY="audioOutputReady",m.FINISH_CONVERT="finishConvert",m.ENTER_PIP="enterPIP",m.LEAVE_PIP="leavePIP",m.ENTERPICTUREINPICTURE="enterpictureinpicture",m.LEAVEPICTUREINPICTURE="leavepictureinpicture",Object.freeze(m);var g=m;const v=s.a.getComponent("Button"),R=s.a.getComponent("Component");class E extends v{buildCSSClass(){return"vjs-camera-button vjs-control vjs-button vjs-icon-photo-camera"}enable(){super.enable(),this.on(this.player_,g.START_RECORD,this.onStart),this.on(this.player_,g.STOP_RECORD,this.onStop)}disable(){super.disable(),this.off(this.player_,g.START_RECORD,this.onStart),this.off(this.player_,g.STOP_RECORD,this.onStop)}show(){this.layoutExclude&&!0===this.layoutExclude||super.show()}handleClick(e){let t=this.player_.record();t.isProcessing()?(t.retrySnapshot(),this.onStop()):t.start()}onStart(e){this.removeClass("vjs-icon-photo-camera"),this.addClass("vjs-icon-replay"),this.controlText("Retry")}onStop(e){this.removeClass("vjs-icon-replay"),this.addClass("vjs-icon-photo-camera"),this.controlText("Image")}}E.prototype.controlText_="Image",R.registerComponent("CameraButton",E);var f=E;const T=s.a.getComponent("Button"),D=s.a.getComponent("Component");class b extends T{buildCSSClass(){return"vjs-record-button vjs-control vjs-button vjs-icon-record-start"}enable(){super.enable(),this.on(this.player_,g.START_RECORD,this.onStart),this.on(this.player_,g.STOP_RECORD,this.onStop)}disable(){super.disable(),this.off(this.player_,g.START_RECORD,this.onStart),this.off(this.player_,g.STOP_RECORD,this.onStop)}show(){this.layoutExclude&&!0===this.layoutExclude||super.show()}handleClick(e){let t=this.player_.record();t.isRecording()?t.stop():t.start()}onStart(e){this.removeClass("vjs-icon-record-start"),this.addClass("vjs-icon-record-stop"),this.controlText("Stop")}onStop(e){this.removeClass("vjs-icon-record-stop"),this.addClass("vjs-icon-record-start"),this.controlText("Record")}}b.prototype.controlText_="Record",D.registerComponent("RecordToggle",b);var C=b;const A=s.a.getComponent("Component");class w extends A{constructor(e,t){super(e,t),this.enable()}createEl(){let e={"data-label":this.localize("REC")};return super.createEl("div",{className:"vjs-record-indicator vjs-control",dir:"ltr"},e)}enable(){this.on(this.player_,g.START_RECORD,this.show),this.on(this.player_,g.STOP_RECORD,this.hide)}disable(){this.off(this.player_,g.START_RECORD,this.show),this.off(this.player_,g.STOP_RECORD,this.hide)}show(){this.layoutExclude&&!0===this.layoutExclude||super.show()}}A.registerComponent("RecordIndicator",w);var _=w;const S=s.a.getComponent("Button"),P=s.a.getComponent("Component");class O extends S{constructor(e,t){super(e,t),this.on(this.player_,g.ENTER_PIP,this.onStart),this.on(this.player_,g.LEAVE_PIP,this.onStop)}buildCSSClass(){return"vjs-pip-button vjs-control vjs-button vjs-icon-picture-in-picture-start"}show(){this.layoutExclude&&!0===this.layoutExclude||super.show()}async handleClick(e){let t=this.player_.record();this.disable();try{t.mediaElement!==document.pictureInPictureElement?await t.mediaElement.requestPictureInPicture():await document.exitPictureInPicture()}catch(e){this.player_.trigger(g.ERROR,e)}finally{this.enable()}}onStart(e){this.removeClass("vjs-icon-picture-in-picture-start"),this.addClass("vjs-icon-picture-in-picture-stop")}onStop(e){this.removeClass("vjs-icon-picture-in-picture-stop"),this.addClass("vjs-icon-picture-in-picture-start")}}O.prototype.controlText_="Picture in Picture",P.registerComponent("PictureInPictureToggle",O);var k=O;const I="image_only",U="audio_only",B="video_only",L="audio_video",j="animation",M="screen_only",x=function(e,t,i,r,s){return N(e)?I:N(r)?j:N(s)?M:N(t)&&!N(i)?U:N(t)&&N(i)?L:!N(t)&&N(i)?B:void 0},N=function(e){return e===Object(e)||!0===e};var V=function(e){switch(e.which){case 88:switch(this.player_.record().getRecordType()){case I:this.player_.cameraButton.trigger("click");break;default:this.player_.recordToggle.trigger("click")}break;case 80:!0===this.player_.record().pictureInPicture&&this.player_.pipToggle.trigger("click");break;case 67:this.player_.controlBar.playToggle&&this.player_.controlBar.playToggle.contentEl()&&player.controlBar.playToggle.trigger("click")}};var F={image:!1,audio:!1,video:!1,animation:!1,screen:!1,maxLength:10,maxFileSize:0,msDisplayMax:3,frameWidth:320,frameHeight:240,debug:!1,pip:!1,autoMuteDevice:!1,videoEngine:"recordrtc",videoMimeType:"video/webm",videoRecorderType:"auto",videoWorkerURL:"",videoWebAssemblyURL:"",audioEngine:"recordrtc",audioRecorderType:"auto",audioMimeType:"auto",audioBufferSize:4096,audioSampleRate:44100,audioBitRate:128,audioChannels:2,audioWorkerURL:"",audioWebAssemblyURL:"",audioBufferUpdate:!1,animationFrameRate:200,animationQuality:10,timeSlice:0,convertEngine:"",hotKeys:!1};var W=function(e,t,i){e=e<0?0:e,t=t||e;let r=Math.floor(e%60),s=Math.floor(e/60%60),o=Math.floor(e/3600),a=Math.floor(t/60%60),n=Math.floor(t/3600),h=Math.floor(1e3*(e-r));return(isNaN(e)||e===1/0)&&(o=s=r=h="-"),t>0&&t<i?(h<100&&(h=h<10?"00"+h:"0"+h),h=":"+h):h="",(o=o>0||n>0?o+":":"")+(s=((o||a>=10)&&s<10?"0"+s:s)+":")+(r=r<10?"0"+r:r)+h};var H=function(e,t){"srcObject"in t?t.srcObject=e:"mozSrcObject"in t?t.mozSrcObject=e:t.srcObject=e},z=i(1),Y=i.n(z);const q=function(){let e={browser:null,version:null,minVersion:null};if(void 0===Y.a||!Y.a.navigator)return e.browser="Not a supported browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=G(navigator.userAgent,/Firefox\/(\d+)\./,1),e.minVersion=31;else if(navigator.webkitGetUserMedia)e.browser="chrome",e.version=G(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2),e.minVersion=38;else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e.browser="edge",e.version=G(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),e.minVersion=10547;else{if(!Y.a.RTCPeerConnection||!navigator.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=G(navigator.userAgent,/AppleWebKit\/(\d+)\./,1)}return e},G=function(e,t,i){let r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)};var K=i(2),Q=i.n(K);const $=function(e,t){if(void 0!==navigator.msSaveOrOpenBlob)return navigator.msSaveOrOpenBlob(t,e);if(void 0!==navigator.msSaveBlob)return navigator.msSaveBlob(t,e);let i=document.createElement("a");i.href=URL.createObjectURL(t),i.download=e,i.style="display:none;opacity:0;color:transparent;",(document.body||document.documentElement).appendChild(i),"function"==typeof i.click?i.click():(i.target="_blank",i.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))),URL.revokeObjectURL(i.href)},J=function(e){return new Promise((t,i)=>{const r=new FileReader;r.onloadend=(()=>{t(r.result)}),r.onerror=(e=>{i(e.error)}),r.readAsArrayBuffer(e)})},X=function(e,t){if(e instanceof Blob||e instanceof File){void 0===t&&(t=new Date);try{e.lastModified=t.getTime(),e.lastModifiedDate=t}catch(e){if(!(e instanceof TypeError))throw e}let i="."+e.type.split("/")[1];i.indexOf(";")>-1&&(i=i.split(";")[0]);try{e.name=t.getTime()+i}catch(e){if(!(e instanceof TypeError))throw e}}},Z=s.a.getComponent("Component"),ee=["libvorbis.js","recorder.js","lamejs","opus-recorder","vmsg"],te=["webm-wasm"];ee.concat(te);class ie extends Z{constructor(e,t){t.evented=!0,super(e,t)}dispose(){void 0!==this.recordedData&&URL.revokeObjectURL(this.recordedData)}destroy(){}addFileInfo(e){X(e)}onStopRecording(e){this.recordedData=e,this.addFileInfo(this.recordedData),this.dispose(),this.trigger(g.RECORD_COMPLETE)}saveAs(e){let t=e[Object.keys(e)[0]];$(t,this.recordedData)}}s.a.RecordEngine=ie,Z.registerComponent("RecordEngine",ie);const re=s.a.getComponent("Component");class se extends ie{setup(e,t,i){this.inputStream=e,this.mediaType=t,this.debug=i,"screen"in this.mediaType&&(this.mediaType.video=!0),void 0!==this.recorderType&&(this.mediaType.video=this.recorderType),this.engine=new Q.a.MRecordRTC,this.engine.mediaType=this.mediaType,this.engine.disableLogs=!this.debug,this.engine.mimeType=this.mimeType,this.engine.bufferSize=this.bufferSize,this.engine.sampleRate=this.sampleRate,this.engine.numberOfAudioChannels=this.audioChannels,this.engine.video=this.video,this.engine.canvas=this.canvas,this.engine.quality=this.quality,this.engine.frameRate=this.frameRate,void 0!==this.onTimeStamp&&(this.engine.timeSlice=this.timeSlice,this.engine.onTimeStamp=this.onTimeStamp),this.engine.workerPath=this.workerPath,this.engine.webAssemblyPath=this.videoWebAssemblyURL,this.engine.addStream(this.inputStream)}dispose(){super.dispose(),this.destroy()}destroy(){this.engine&&"function"==typeof this.engine.destroy&&this.engine.destroy()}start(){this.engine.startRecording()}stop(){this.engine.stopRecording(this.onStopRecording.bind(this))}pause(){this.engine.pauseRecording()}resume(){this.engine.resumeRecording()}saveAs(e){this.engine&&void 0!==e&&this.engine.save(e)}onStopRecording(e,t){URL.revokeObjectURL(e);let i=this.player().record().getRecordType();this.engine.getBlob(e=>{switch(i){case U:void 0!==e.audio&&(this.recordedData=e.audio);break;case B:case L:case M:void 0!==e.video&&(this.recordedData=e.video);break;case j:void 0!==e.gif&&(this.recordedData=e.gif)}this.addFileInfo(this.recordedData),this.trigger(g.RECORD_COMPLETE)})}}s.a.RecordRTCEngine=se,re.registerComponent("RecordRTCEngine",se);var oe=se;const ae=s.a.getComponent("Component");class ne extends ae{constructor(e,t){t.evented=!0,super(e,t)}setup(e,t){this.mediaType=e,this.debug=t}loadBlob(e){return J(e)}addFileInfo(e,t){X(e,t)}}s.a.ConvertEngine=ne,ae.registerComponent("ConvertEngine",ne);const he=function(e){let t;switch(e){case"recordrtc":t=oe;break;case"libvorbis.js":t=videojs.LibVorbisEngine;break;case"recorder.js":t=videojs.RecorderjsEngine;break;case"lamejs":t=videojs.LamejsEngine;break;case"opus-recorder":t=videojs.OpusRecorderEngine;break;case"vmsg":t=videojs.VmsgEngine;break;default:throw new Error("Unknown audioEngine: "+e)}return t},de=function(e){let t;switch(e){case"recordrtc":t=oe;break;case"webm-wasm":t=videojs.WebmWasmEngine;break;default:throw new Error("Unknown videoEngine: "+e)}return t},ce=function(e){return ee.indexOf(e)>-1},le=function(e){let t;switch(e){case"":break;case"ts-ebml":t=videojs.TsEBMLEngine;break;default:throw new Error("Unknown convertEngine: "+e)}return t};i.d(t,"Record",function(){return me});const pe=s.a.getPlugin("plugin"),ue=s.a.getComponent("Player"),ye="auto";ue.prototype.play=function(){let e=this.techGet_("play");return void 0!==e&&"function"==typeof e.then&&e.then(null,e=>{}),e};class me extends pe{constructor(e,t){super(e,t),e.addClass("vjs-record"),this.loadOptions(),this.resetState();let i="av-perm";switch(this.getRecordType()){case I:case B:case j:i="video-perm";break;case U:i="audio-perm";break;case M:i="screen-perm"}if(y.prototype.buildCSSClass=(()=>"vjs-record vjs-device-button vjs-control vjs-icon-"+i),e.deviceButton=new y(e,t),e.addChild(e.deviceButton),e.recordIndicator=new _(e,t),e.recordIndicator.hide(),e.addChild(e.recordIndicator),e.recordCanvas=new c(e,t),e.recordCanvas.hide(),e.addChild(e.recordCanvas),e.animationDisplay=new n(e,t),e.animationDisplay.hide(),e.addChild(e.animationDisplay),e.cameraButton=new f(e,t),e.cameraButton.hide(),e.recordToggle=new C(e,t),e.recordToggle.hide(),e.pipToggle=new k(e,t),e.pipToggle.hide(),!0===this.pictureInPicture&&(this.onEnterPiPHandler=this.onEnterPiP.bind(this),this.onLeavePiPHandler=this.onLeavePiP.bind(this)),this.player.options_.controlBar){["deviceButton","recordIndicator","cameraButton","recordToggle","pipToggle"].forEach(e=>{void 0!==this.player.options_.controlBar[e]&&(this.player[e].layoutExclude=!0,this.player[e].hide())})}this.player.one(g.READY,this.setupUI.bind(this))}loadOptions(e={}){let t=s.a.mergeOptions(F,this.player.options_.plugins.record,e);this.recordImage=t.image,this.recordAudio=t.audio,this.recordVideo=t.video,this.recordAnimation=t.animation,this.recordScreen=t.screen,this.maxLength=t.maxLength,this.maxFileSize=t.maxFileSize,this.msDisplayMax=parseFloat(t.msDisplayMax),this.debug=t.debug,this.pictureInPicture=t.pip,this.recordTimeSlice=t.timeSlice,this.autoMuteDevice=t.autoMuteDevice,this.videoFrameWidth=t.frameWidth,this.videoFrameHeight=t.frameHeight,this.videoEngine=t.videoEngine,this.videoRecorderType=t.videoRecorderType,this.videoMimeType=t.videoMimeType,this.videoWorkerURL=t.videoWorkerURL,this.videoWebAssemblyURL=t.videoWebAssemblyURL,this.convertEngine=t.convertEngine,this.audioEngine=t.audioEngine,this.audioRecorderType=t.audioRecorderType,this.audioWorkerURL=t.audioWorkerURL,this.audioWebAssemblyURL=t.audioWebAssemblyURL,this.audioBufferSize=t.audioBufferSize,this.audioSampleRate=t.audioSampleRate,this.audioBitRate=t.audioBitRate,this.audioChannels=t.audioChannels,this.audioMimeType=t.audioMimeType,this.audioBufferUpdate=t.audioBufferUpdate,this.animationFrameRate=t.animationFrameRate,this.animationQuality=t.animationQuality}setupUI(){switch(this.player.controlBar.addChild(this.player.cameraButton),this.player.controlBar.el().insertBefore(this.player.cameraButton.el(),this.player.controlBar.el().firstChild),this.player.controlBar.el().insertBefore(this.player.recordToggle.el(),this.player.controlBar.el().firstChild),this.player.controlBar.addChild(this.player.pipToggle),void 0!==this.player.controlBar.remainingTimeDisplay&&(this.player.controlBar.remainingTimeDisplay.el().style.display="none"),void 0!==this.player.controlBar.liveDisplay&&(this.player.controlBar.liveDisplay.el().style.display="none"),this.player.loop(!1),this.getRecordType()){case U:this.surfer=this.player.wavesurfer();break;case I:case B:case L:case j:case M:this.player.bigPlayButton.hide(),this.player.one(g.LOADEDMETADATA,()=>{this.setDuration(this.maxLength)}),this.player.one(g.LOADSTART,()=>{this.setDuration(this.maxLength)}),!0===this.player.usingNativeControls_&&void 0!==this.player.tech_.el_&&(this.player.tech_.el_.controls=!1),this.player.removeTechControlsListeners_(),this.player.options_.controls&&(void 0!==this.player.controlBar.progressControl&&this.player.controlBar.progressControl.hide(),this.player.on(g.USERINACTIVE,e=>{this.player.userActive(!0)}),this.player.controlBar.show(),this.player.controlBar.el().style.display="flex")}if(this.player.off(g.TIMEUPDATE),this.player.off(g.DURATIONCHANGE),this.player.off(g.LOADEDMETADATA),this.player.off(g.LOADSTART),this.setDuration(this.maxLength),this.player.options_.plugins.record&&this.player.options_.plugins.record.hotKeys&&!1!==this.player.options_.plugins.record.hotKeys){let e=this.player.options_.plugins.record.hotKeys;!0===e&&(e=V),this.player.options_.userActions={hotkeys:e}}void 0!==this.player.controlBar.playToggle&&this.player.controlBar.playToggle.hide()}isRecording(){return this._recording}isProcessing(){return this._processing}isDestroyed(){let e=null===this.player;return!1===e&&(e=null===this.player.children()),e}getDevice(){if(void 0===this.deviceReadyCallback&&(this.deviceReadyCallback=this.onDeviceReady.bind(this)),void 0===this.deviceErrorCallback&&(this.deviceErrorCallback=this.onDeviceError.bind(this)),void 0===this.engineStopCallback&&(this.engineStopCallback=this.onRecordComplete.bind(this)),this.getRecordType()===M){if(void 0===navigator.mediaDevices||void 0===navigator.mediaDevices.getDisplayMedia)return void this.player.trigger(g.ERROR,"This browser does not support navigator.mediaDevices.getDisplayMedia")}else if(void 0===navigator.mediaDevices||void 0===navigator.mediaDevices.getUserMedia)return void this.player.trigger(g.ERROR,"This browser does not support navigator.mediaDevices.getUserMedia");switch(this.getRecordType()){case U:this.mediaType={audio:this.audioRecorderType===ye||this.audioRecorderType,video:!1},this.surfer.surfer.microphone.un(g.DEVICE_READY,this.deviceReadyCallback),this.surfer.surfer.microphone.un(g.DEVICE_ERROR,this.deviceErrorCallback),this.surfer.surfer.microphone.on(g.DEVICE_READY,this.deviceReadyCallback),this.surfer.surfer.microphone.on(g.DEVICE_ERROR,this.deviceErrorCallback),this.surfer.setupPlaybackEvents(!1),this.surfer.liveMode=!0,this.surfer.surfer.microphone.paused=!1,"suspended"===this.surfer.surfer.backend.ac.state&&this.surfer.surfer.backend.ac.resume(),!0===this.audioBufferUpdate&&(this.surfer.surfer.microphone.reloadBufferFunction=(e=>{this.surfer.surfer.microphone.paused||(this.surfer.surfer.empty(),this.surfer.surfer.loadDecodedBuffer(e.inputBuffer),this.player.recordedData=e.inputBuffer,this.player.trigger(g.AUDIO_BUFFER_UPDATE))})),this.surfer.surfer.microphone.start();break;case I:case B:this.mediaType={audio:!1,video:this.videoRecorderType===ye||this.videoRecorderType},navigator.mediaDevices.getUserMedia({audio:!1,video:this.getRecordType()===I?this.recordImage:this.recordVideo}).then(this.onDeviceReady.bind(this)).catch(this.onDeviceError.bind(this));break;case L:this.mediaType={audio:this.audioRecorderType===ye||this.audioRecorderType,video:this.videoRecorderType===ye||this.videoRecorderType},navigator.mediaDevices.getUserMedia({audio:this.recordAudio,video:this.recordVideo}).then(this.onDeviceReady.bind(this)).catch(this.onDeviceError.bind(this));break;case j:this.mediaType={audio:!1,video:!1,gif:!0},navigator.mediaDevices.getUserMedia({audio:!1,video:this.recordAnimation}).then(this.onDeviceReady.bind(this)).catch(this.onDeviceError.bind(this));break;case M:this.mediaType={audio:!1,video:!1,screen:!0,gif:!1},navigator.mediaDevices.getDisplayMedia({video:!0}).then(this.onDeviceReady.bind(this)).catch(this.onDeviceError.bind(this))}}onDeviceReady(e){if(this._deviceActive=!0,this.stream=e,this.player.deviceButton.hide(),this.setDuration(this.maxLength),this.setCurrentTime(0),void 0!==this.player.controlBar.playToggle&&this.player.controlBar.playToggle.hide(),this.off(this.player,g.TIMEUPDATE,this.playbackTimeUpdate),this.off(this.player,g.ENDED,this.playbackTimeUpdate),this.getRecordType()!==I){if(this.getRecordType()!==U&&ce(this.audioEngine))throw new Error("Currently "+this.audioEngine+" is only supported in audio-only mode.");let e,t;switch(this.getRecordType()){case U:e=he(this.audioEngine),t=this.audioEngine;break;default:e=de(this.videoEngine),t=this.videoEngine}try{this.engine=new e(this.player,this.player.options_)}catch(e){throw new Error("Could not load "+t+" plugin")}if(this.engine.on(g.RECORD_COMPLETE,this.engineStopCallback),this.engine.bufferSize=this.audioBufferSize,this.engine.sampleRate=this.audioSampleRate,this.engine.bitRate=this.audioBitRate,this.engine.audioChannels=this.audioChannels,this.engine.audioWorkerURL=this.audioWorkerURL,this.engine.audioWebAssemblyURL=this.audioWebAssemblyURL,this.engine.mimeType={video:this.videoMimeType,gif:"image/gif"},null!==this.audioMimeType&&this.audioMimeType!==ye&&(this.engine.mimeType.audio=this.audioMimeType),this.engine.videoWorkerURL=this.videoWorkerURL,this.engine.videoWebAssemblyURL=this.videoWebAssemblyURL,this.engine.video={width:this.videoFrameWidth,height:this.videoFrameHeight},this.engine.canvas={width:this.videoFrameWidth,height:this.videoFrameHeight},this.engine.quality=this.animationQuality,this.engine.frameRate=this.animationFrameRate,this.recordTimeSlice&&this.recordTimeSlice>0&&(this.engine.timeSlice=this.recordTimeSlice,this.engine.onTimeStamp=this.onTimeStamp.bind(this)),this.engine.setup(this.stream,this.mediaType,this.debug),""!==this.convertEngine){let e=le(this.convertEngine);try{this.converter=new e(this.player,this.player.options_)}catch(e){throw new Error("Could not load "+this.convertEngine+" plugin")}this.converter.setup(this.mediaType,this.debug)}["currentTimeDisplay","timeDivider","durationDisplay"].forEach(e=>{void 0!==(e=this.player.controlBar[e])&&(e.el().style.display="block",e.show())}),this.player.recordToggle.show()}else this.player.recordIndicator.disable(),this.retrySnapshot(),this.player.cameraButton.onStop(),this.player.cameraButton.show();this.getRecordType()!==U?(this.mediaElement=this.player.el().firstChild,this.mediaElement.controls=!1,this.mediaElement.muted=!0,this.displayVolumeControl(!1),!0===this.pictureInPicture&&(this.player.pipToggle.show(),this.mediaElement.removeEventListener(g.ENTERPICTUREINPICTURE,this.onEnterPiPHandler),this.mediaElement.removeEventListener(g.LEAVEPICTUREINPICTURE,this.onLeavePiPHandler),this.mediaElement.addEventListener(g.ENTERPICTUREINPICTURE,this.onEnterPiPHandler),this.mediaElement.addEventListener(g.LEAVEPICTUREINPICTURE,this.onLeavePiPHandler)),this.load(this.stream),this.player.one(g.LOADEDMETADATA,()=>{this.mediaElement.play(),this.player.trigger(g.DEVICE_READY)})):this.player.trigger(g.DEVICE_READY)}onDeviceError(e){this._deviceActive=!1,this.isDestroyed()||(this.player.deviceErrorCode=e,this.player.trigger(g.DEVICE_ERROR))}start(){if(!this.isProcessing()){switch(this._recording=!0,void 0!==this.player.controlBar.playToggle&&this.player.controlBar.playToggle.hide(),this.off(this.player,g.TIMEUPDATE,this.playbackTimeUpdate),this.off(this.player,g.ENDED,this.playbackTimeUpdate),this.getRecordType()){case U:this.surfer.setupPlaybackEvents(!1),this.surfer.surfer.microphone.paused=!1,this.surfer.liveMode=!0,this.surfer.surfer.microphone.play();break;case B:case L:case M:this.startVideoPreview();break;case j:this.player.recordCanvas.hide(),this.player.animationDisplay.hide(),this.mediaElement.style.display="block",this.captureFrame().then(e=>{this.startVideoPreview()})}switch(this.autoMuteDevice&&this.muteTracks(!1),this.getRecordType()){case I:this.createSnapshot(),this.player.trigger(g.START_RECORD);break;case B:case L:case j:case M:this.player.one(g.LOADEDMETADATA,()=>{this.startRecording()});break;default:this.startRecording()}}}startRecording(){this.paused=!1,this.pauseTime=this.pausedTime=0,this.startTime=performance.now();this.countDown=this.player.setInterval(this.onCountDown.bind(this),100),void 0!==this.engine&&this.engine.dispose(),this.engine.start(),this.player.trigger(g.START_RECORD)}stop(){this.isProcessing()||(this._recording=!1,this._processing=!0,this.getRecordType()!==I?(this.player.trigger(g.STOP_RECORD),this.player.clearInterval(this.countDown),this.engine&&this.engine.stop(),this.autoMuteDevice&&this.muteTracks(!0)):this.player.recordedData&&this.player.trigger(g.FINISH_RECORD))}stopDevice(){this.isRecording()?(this.player.one(g.FINISH_RECORD,this.stopStream.bind(this)),this.stop()):this.stopStream()}stopStream(){if(this.stream){if(this._deviceActive=!1,this.getRecordType()===U)return void this.surfer.surfer.microphone.stopDevice();this.stream.getTracks().forEach(e=>{e.stop()})}}pause(){this.paused||(this.pauseTime=performance.now(),this.paused=!0,this.engine.pause())}resume(){this.paused&&(this.pausedTime+=performance.now()-this.pauseTime,this.engine.resume(),this.paused=!1)}onRecordComplete(){if(this.player.recordedData=this.engine.recordedData,void 0!==this.player.controlBar.playToggle&&(this.player.controlBar.playToggle.removeClass("vjs-ended"),this.player.controlBar.playToggle.show()),void 0!==this.converter&&this.converter.convert(this.player.recordedData),this.player.trigger(g.FINISH_RECORD),!this.isDestroyed())switch(this.getRecordType()){case U:this.surfer.pause(),this.surfer.setupPlaybackEvents(!0),this.player.loadingSpinner.show(),this.surfer.surfer.once(g.READY,()=>{this._processing=!1}),this.load(this.player.recordedData);break;case B:case L:case M:this.player.one(g.PAUSE,()=>{this._processing=!1,this.player.loadingSpinner.hide(),this.setDuration(this.streamDuration),this.on(this.player,g.TIMEUPDATE,this.playbackTimeUpdate),this.on(this.player,g.ENDED,this.playbackTimeUpdate),this.getRecordType()===L&&(this.mediaElement.muted=!1,this.displayVolumeControl(!0)),this.load(this.player.recordedData)}),this.player.pause();break;case j:this._processing=!1,this.player.loadingSpinner.hide(),this.setDuration(this.streamDuration),this.mediaElement.style.display="none",this.player.recordCanvas.show(),this.player.pause(),this.on(this.player,g.PLAY,this.showAnimation),this.on(this.player,g.PAUSE,this.hideAnimation)}}onCountDown(){if(!this.paused){let e=performance.now(),t=this.maxLength,i=(e-(this.startTime+this.pausedTime))/1e3;this.streamDuration=i,i>=t&&(i=t,this.stop()),this.setDuration(t),this.setCurrentTime(i,t),this.player.trigger(g.PROGRESS_RECORD)}}getCurrentTime(){let e=isNaN(this.streamCurrentTime)?0:this.streamCurrentTime;return this.getRecordType()===U&&(e=this.surfer.getCurrentTime()),e}setCurrentTime(e,t){switch(e=isNaN(e)?0:e,t=isNaN(t)?0:t,this.getRecordType()){case U:this.surfer.setCurrentTime(e,t);break;case B:case L:case j:case M:this.player.controlBar.currentTimeDisplay&&this.player.controlBar.currentTimeDisplay.contentEl()&&(this.streamCurrentTime=Math.min(e,t),this.player.controlBar.currentTimeDisplay.formattedTime_=this.player.controlBar.currentTimeDisplay.contentEl().lastChild.textContent=W(this.streamCurrentTime,t,this.msDisplayMax))}}getDuration(){return isNaN(this.streamDuration)?0:this.streamDuration}setDuration(e){switch(e=isNaN(e)?0:e,this.getRecordType()){case U:this.surfer.setDuration(e);break;case B:case L:case j:case M:this.player.controlBar.durationDisplay&&this.player.controlBar.durationDisplay.contentEl()&&(this.player.controlBar.durationDisplay.formattedTime_=this.player.controlBar.durationDisplay.contentEl().lastChild.textContent=W(e,e,this.msDisplayMax))}}load(e){switch(this.getRecordType()){case U:this.surfer.load(e);break;case I:case B:case L:case j:case M:e instanceof Blob||e instanceof File?(this.mediaElement.srcObject=null,this.mediaElement.src=URL.createObjectURL(e)):H(e,this.mediaElement)}}saveAs(e){this.engine&&void 0!==e&&this.engine.saveAs(e)}dispose(){this.player.off(g.READY),this.player.off(g.USERINACTIVE),this.player.off(g.LOADEDMETADATA),this.engine&&(this.engine.dispose(),this.engine.destroy(),this.engine.off(g.RECORD_COMPLETE,this.engineStopCallback)),this.stop(),this.stopDevice(),this.removeRecording(),this.player.clearInterval(this.countDown),this.getRecordType()===U&&this.surfer&&this.surfer.destroy(),this.resetState(),super.dispose()}destroy(){this.player.dispose()}reset(){switch(this.engine&&(this.engine.dispose(),this.engine.off(g.RECORD_COMPLETE,this.engineStopCallback)),this.stop(),this.stopDevice(),this.player.clearInterval(this.countDown),this.removeRecording(),this.loadOptions(),this.resetState(),this.setDuration(this.maxLength),this.setCurrentTime(0),this.player.reset(),this.getRecordType()){case U:this.surfer&&this.surfer.surfer&&this.surfer.surfer.empty();break;case I:case j:this.player.recordCanvas.hide(),this.player.cameraButton.hide()}void 0!==this.player.controlBar.playToggle&&this.player.controlBar.playToggle.hide(),this.player.deviceButton.show(),this.player.recordToggle.hide(),this.player.one(g.LOADEDMETADATA,()=>{this.setDuration(this.maxLength)})}resetState(){this._recording=!1,this._processing=!1,this._deviceActive=!1,this.devices=[]}removeRecording(){this.mediaElement&&!0===this.mediaElement.src.startsWith("blob:")&&(URL.revokeObjectURL(this.mediaElement.src),this.mediaElement.src="")}muteTracks(e){(this.getRecordType()===U||this.getRecordType()===L)&&this.stream.getAudioTracks().length>0&&(this.stream.getAudioTracks()[0].enabled=!e),this.getRecordType()!==U&&this.stream.getVideoTracks().length>0&&(this.stream.getVideoTracks()[0].enabled=!e)}getRecordType(){return x(this.recordImage,this.recordAudio,this.recordVideo,this.recordAnimation,this.recordScreen)}createSnapshot(){this.captureFrame().then(e=>{this.player.recordedData=e.toDataURL("image/png"),this.mediaElement.style.display="none",this.player.recordCanvas.show(),this.stop()})}retrySnapshot(){this._processing=!1,this.player.recordCanvas.hide(),this.player.el().firstChild.style.display="block"}captureFrame(){let e=q(),t=this.player.recordCanvas.el().firstChild;return t.width=this.player.width(),t.height=this.player.height(),new Promise((i,r)=>{if("chrome"===e.browser&&e.version>=60&&typeof ImageCapture==typeof Function)try{let e=this.stream.getVideoTracks()[0];new ImageCapture(e).grabFrame().then(e=>{this.drawCanvas(t,e),i(t)}).catch(e=>{})}catch(e){}this.drawCanvas(t,this.mediaElement),i(t)})}drawCanvas(e,t){e.getContext("2d").drawImage(t,0,0,e.width,e.height)}startVideoPreview(){this.off(g.TIMEUPDATE),this.off(g.DURATIONCHANGE),this.off(g.LOADEDMETADATA),this.off(g.PLAY),this.mediaElement.muted=!0,this.displayVolumeControl(!1),this.removeRecording(),this.load(this.stream),this.mediaElement.play()}showAnimation(){let e=this.player.animationDisplay.el().firstChild;e.width=this.player.width(),e.height=this.player.height(),this.player.recordCanvas.hide(),H(this.player.recordedData,e),this.player.animationDisplay.show()}hideAnimation(){this.player.recordCanvas.show(),this.player.animationDisplay.hide()}playbackTimeUpdate(){this.setCurrentTime(this.player.currentTime(),this.streamDuration)}onTimeStamp(e,t){let i;switch(this.player.currentTimestamp=e,this.player.allTimestamps=t,this.getRecordType()){case U:i=this.engine.engine.audioRecorder;break;case j:i=this.engine.engine.gifRecorder;break;default:i=this.engine.engine.videoRecorder}let r=!1;if(i&&(i=i.getInternalRecorder()),i instanceof MediaStreamRecorder==!0&&(this.player.recordedData=i.getArrayOfBlobs(),this.engine.addFileInfo(this.player.recordedData[this.player.recordedData.length-1]),this.maxFileSize>0)){new Blob(this.player.recordedData).size>=this.maxFileSize&&(r=!0)}this.player.trigger(g.TIMESTAMP),r&&this.stop()}enumerateDevices(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return this.player.enumerateErrorCode="enumerateDevices() not supported.",void this.player.trigger(g.ENUMERATE_ERROR);navigator.mediaDevices.enumerateDevices(this).then(e=>{this.devices=[],e.forEach(e=>{this.devices.push(e)}),this.player.trigger(g.ENUMERATE_READY)}).catch(e=>{this.player.enumerateErrorCode=e,this.player.trigger(g.ENUMERATE_ERROR)})}setAudioOutput(e){let t;switch(this.getRecordType()){case U:this.surfer.surfer.setSinkId(e).then(e=>{this.player.trigger(g.AUDIO_OUTPUT_READY)}).catch(e=>{t=e});break;default:let i=player.tech_.el_;e?void 0!==i.sinkId?i.setSinkId(e).then(e=>{this.player.trigger(g.AUDIO_OUTPUT_READY)}).catch(e=>{t=e}):t="Browser does not support audio output device selection.":t="Invalid deviceId: "+e}this.player.trigger(g.ERROR,t)}displayVolumeControl(e){void 0!==this.player.controlBar.volumePanel&&(e=!0===e?"flex":"none",this.player.controlBar.volumePanel.el().style.display=e)}onEnterPiP(e){this.player.trigger(g.ENTER_PIP,e)}onLeavePiP(e){this.player.trigger(g.LEAVE_PIP)}}me.VERSION="3.6.0",s.a.Record=me,void 0===s.a.getPlugin("record")&&s.a.registerPlugin("record",me)}])});